<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: user_management.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: user_management.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>"use strict";
var __awaiter = (this &amp;&amp; this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const pass = require("passport");
const local = require("passport-local");
const userSchema_1 = require("../models/userSchema");
const helper = require("../server/helper");
/**
 * Contains the various authentication/signup methods.
 * @class
 */
class Authentication {
    /**
     * Initializes the Authentication class.
     * @constructor
     */
    constructor() {
        this.passport = new pass.Passport();
        this.setupSerialization();
        this.SignupStrat();
        this.loginStrat();
        this.passport.use("local-signup", this.SignupStrategy);
        this.passport.use("local-login", this.LoginStrategy);
    }
    /**
     * Sets up the serialization for passport.
     * @function
     */
    setupSerialization() {
        //How to save user.
        this.passport.serializeUser((user, done) => {
            done(null, user.id);
        });
        //How to get user.
        this.passport.deserializeUser((id, done) => {
            userSchema_1.model.findById(id, (err, user) => {
                done(err, user);
            });
        });
    }
    /**
     * Initializes the signup strategy for passport.
     * @function
     */
    SignupStrat() {
        this.SignupStrategy = new local.Strategy({ passReqToCallback: true }, //True, so that the whole request can be accessed.
        (req, username, password, done) => {
            process.nextTick(() => {
                //So everything is there - copied from guide
                userSchema_1.model.findOne({ username: username }, (err, user) => {
                    //Looks for the model with the username in the database.
                    if (err)
                        return done(err);
                    if (user) {
                        return done(null, false, req.flash("signupMessage", "Username already taken"));
                    }
                    else {
                        let newUser = new userSchema_1.model({
                            username: username,
                            password: password,
                            email: req.body.email
                        });
                        helper.hashPwAndSave(newUser);
                        req.flash("signupSuccessful", "The account was created successfully.");
                    }
                });
            });
        });
    }
    /**
     * Initializes the login strategy for passport.
     * @function
     */
    loginStrat() {
        this.LoginStrategy = new local.Strategy({ passReqToCallback: true }, (req, username, password, done) => {
            userSchema_1.model.findOne({ username: username }, (err, user) => __awaiter(this, void 0, void 0, function* () {
                if (err)
                    return done(err);
                if (!user)
                    //If the user doesn't exist
                    return done(null, false, req.flash("loginMessage", "Username or password is wrong."));
                //Waits for the password check.
                let isPwValid = yield helper.checkPassword(user.password, password);
                if (!isPwValid) {
                    console.log("wrong pw");
                    return done(null, false, req.flash("loginMessage", "Username or password is wrong."));
                }
                console.log("right pw"); //debugging
                return done(null, user);
            }));
        });
    }
}
exports.Authentication = Authentication;
//# sourceMappingURL=user_management.js.map</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Authentication.html">Authentication</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Thu Dec 14 2017 19:35:22 GMT+0100 (W. Europe Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
